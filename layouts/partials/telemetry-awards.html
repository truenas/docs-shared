{{/* Accept telemetryData from parent shortcode to avoid redundant fetches */}}
{{ $telemetryData := .telemetryData | default dict }}

{{/* If no data was passed, fetch it (fallback for backwards compatibility) */}}
{{ if not $telemetryData }}
  {{ $timestamp := now.Unix }}
  {{ $telemetryURL := printf "https://telemetry.sys.truenas.net/apps/truenas-apps-stats.json?t=%d" $timestamp }}
  {{ $rawData := resources.GetRemote $telemetryURL }}
  {{ $telemetryData = $rawData | transform.Unmarshal | default dict }}
{{ end }}

{{ $appName := .appName | lower }}
{{ $appTrain := .appTrain | lower }}
{{ $telemetryTrain := cond (eq $appTrain "enterprise") "Enterprise" (cond (eq $appTrain "stable") "Stable" "Community") }}

{{/* Get the train data */}}
{{ $trainData := index $telemetryData $telemetryTrain | default dict }}

{{/* Look up the deployment count directly */}}
{{ $deploymentCount := 0 }}
{{ range $k, $v := $trainData }}
  {{ if eq (lower $k) $appName }}
    {{ $deploymentCount = $v }}
  {{ end }}
{{ end }}

{{/* Convert to int to ensure proper comparison */}}
{{ $deploymentCount = int $deploymentCount }}

{{ if gt $deploymentCount 0 }}
  <div class="popular-app">
    {{ if gt $deploymentCount 20000 }}
      <img src="{{ "/images/Gold-Labeled.png" | relURL }}" alt="20,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
    {{ else if gt $deploymentCount 10000 }}
      <img src="{{ "/images/Silver-Labeled.png" | relURL }}" alt="10,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
    {{ else if gt $deploymentCount 5000 }}
      <img src="{{ "/images/Bronze-Labeled.png" | relURL }}" alt="5,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
    {{ else if gt $deploymentCount 2500 }}
      <img src="{{ "/images/Blue-Ribbon-Labeled.png" | relURL }}" alt="2,500 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
    {{ else if gt $deploymentCount 1000 }}
      <img src="{{ "/images/Ribbon-Labeled.png" | relURL }}" alt="1,000 active deployments icon" style="width: 5rem; vertical-align: middle;"><br>
    {{ end }}
  </div>
{{ end }}